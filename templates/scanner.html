<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 코드 스캐너</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            text-align: center; 
            background-color: #333; 
            color: white; 
            margin: 0; 
            padding: 20px;
        }
        #qr-reader-container { 
            max-width: 500px; 
            margin: 20px auto; 
        }
        #qr-reader { 
            border: 5px solid #555; 
            border-radius: 8px; 
        }
        #result-container { 
            margin-top: 20px; 
            font-size: 1.2em; 
        }
        .countdown { 
            font-size: 3em; 
            color: #ffc107; 
        }
        button { 
            padding: 12px 24px; 
            font-size: 1.1em; 
            margin: 10px; 
            cursor: pointer; 
            border-radius: 8px; 
            border: none; 
            font-weight: bold; 
        }
        .btn-success { 
            background-color: #28a745; 
            color: white; 
        }
        .btn-danger { 
            background-color: #dc3545; 
            color: white; 
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <h1>QR 코드 스캐너</h1>
    <p>아래 영역에 QR 코드를 비춰주세요.</p>
    <div id="qr-reader-container">
        <div id="qr-reader"></div>
    </div>
    <div id="result-container"></div>
    <script>
        const resultContainer = document.getElementById('result-container');
        let scannedEmployeeId = null; 
        let html5QrcodeScanner; // 스캐너 객체를 전역 변수로 선언

        function onScanSuccess(decodedText, decodedResult) {
            const employeeId = decodedText; // 이제 디코딩이 필요 없습니다.
            
            html5QrcodeScanner.clear(); // 스캔 성공 후 카메라 중지
            scannedEmployeeId = employeeId;
            
            // 사용자에게 ID를 보여주고 확인 절차 시작
            resultContainer.innerHTML = `<h2>사원 ID (${scannedEmployeeId})님 확인되었습니다.</h2><p>3초간 안전장비를 확인합니다...</p><div id="countdown" class="countdown">3</div>`;
            
            let count = 3;
            const countdownTimer = setInterval(() => {
                count--;
                if (document.getElementById('countdown')) {
                    document.getElementById('countdown').textContent = count;
                }
                if (count <= 0) {
                    clearInterval(countdownTimer);
                    showConfirmationButtons();
                }
            }, 1000);
        }

        function onScanError(errorMessage) { 
            // 스캔 오류는 무시하여 계속 스캔을 시도하도록 둡니다.
        }

        function showConfirmationButtons() {
            resultContainer.innerHTML = `<h2>사원 ID (${scannedEmployeeId})님의 안전장비 상태를 확인해주세요.</h2>
                <button class="btn-success" onclick="sendCheckInData('양호')">착용 완료</button>
                <button class="btn-danger" onclick="sendCheckInData('불량')">미착용</button>`;
        }

        function sendCheckInData(safetyStatus) {
            if (!scannedEmployeeId) {
                resultContainer.innerHTML = `<h2 style="color:red;">오류</h2><p>사원 ID가 인식되지 않았습니다.</p>`;
                setTimeout(() => location.reload(), 3000);
                return;
            }
            resultContainer.innerHTML = `<p>데이터를 전송 중입니다...</p>`;
            fetch('/api/check_in', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employeeId: scannedEmployeeId, safetyCheck: safetyStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    resultContainer.innerHTML = `<h2>전송 완료</h2><p>${data.message || '출근이 기록되었습니다.'}</p><p>5초 후 스캔 화면으로 돌아갑니다.</p>`;
                } else {
                    resultContainer.innerHTML = `<h2 style="color:red;">전송 실패</h2><p>${data.message || '알 수 없는 오류가 발생했습니다.'}</p>`;
                }
                setTimeout(() => location.reload(), 5000);
            })
            .catch(error => {
                console.error('Error:', error);
                resultContainer.innerHTML = `<h2 style="color:red;">전송 실패</h2><p>서버와 통신 중 오류가 발생했습니다.</p>`;
            });
        }
        
        // 페이지의 HTML 구조가 모두 준비되면 스캐너를 실행합니다.
        document.addEventListener('DOMContentLoaded', (event) => {
            try {
                html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: {width: 250, height: 250} });
                html5QrcodeScanner.render(onScanSuccess, onScanError);
            } catch (error) {
                console.error("QR Scanner initialization failed.", error);
                document.getElementById('qr-reader-container').innerHTML = "<p style='color:red;'>QR 스캐너를 시작할 수 없습니다. 카메라 권한을 확인해주세요.</p>"
            }
        });
    </script>
</body>
</html>

